<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的文献库 (维格表版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #f3f4f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // 1. 维格表配置 (请替换这里!)
        // ==========================================
        
        // API Token: 头像 -> 用户中心 -> 开发者配置
        const API_TOKEN = "usk99hJyzO8VQmEFN7XMUCq"; 
        
        // Datasheet ID: 打开表格，地址栏 dst 开头的那串字符
        const DATASHEET_ID = "dstYTWblCwBj76yfJT";

        // ==========================================
        // 2. Vika API 工具函数
        // ==========================================
        const VIKA_API_URL = `https://api.vika.cn/fusion/v1/datasheets/${DATASHEET_ID}/records`;

        // 通用请求头
        const headers = {
            "Authorization": `Bearer ${API_TOKEN}`,
            "Content-Type": "application/json"
        };

        const vika = {
            // 查询数据
            async getAll() {
                // viewId 可以不传，默认查全部
                const res = await fetch(`${VIKA_API_URL}?pageSize=1000`, { headers });
                const json = await res.json();
                if (!json.success) throw new Error(json.message);
                
                // 转换格式，把 fields 拿出来扁平化
                return json.data.records.map(record => ({
                    id: record.recordId,
                    ...record.fields
                }));
            },

            // 新增数据
            async add(paper) {
                const body = {
                    records: [{
                        fields: {
                            "title": paper.title,
                            "author": paper.author,
                            "year": parseInt(paper.year), // 确保是数字
                            "tag": paper.tag,
                            "status": "reading"
                        }
                    }]
                };
                const res = await fetch(VIKA_API_URL, { method: "POST", headers, body: JSON.stringify(body) });
                return await res.json();
            },

            // 更新状态
            async updateStatus(recordId, newStatus) {
                const body = {
                    records: [{
                        recordId: recordId,
                        fields: { "status": newStatus }
                    }]
                };
                const res = await fetch(VIKA_API_URL, { method: "PATCH", headers, body: JSON.stringify(body) });
                return await res.json();
            },

            // 删除数据
            async delete(recordId) {
                const res = await fetch(`${VIKA_API_URL}?recordIds=${recordId}`, { method: "DELETE", headers });
                return await res.json();
            }
        };

        const { useState, useEffect } = React;

        // --- 简单的登录页 (维格表API本身没有用户系统，这里做一个简易的Token验证) ---
        const AuthScreen = ({ onLogin }) => {
            const [token, setToken] = useState(localStorage.getItem('vika_token') || '');
            
            const handleEnter = () => {
                if(token.startsWith("usk")) {
                    // 简单的本地校验
                    localStorage.setItem('vika_token', token);
                    onLogin(token);
                } else {
                    alert("请输入正确的 API Token (以 usk 开头)");
                }
            };

            return (
                <div className="min-h-screen flex flex-col justify-center items-center p-6 bg-white">
                    <div className="w-full max-w-sm text-center">
                        <h1 className="text-2xl font-bold text-slate-800 mb-2">维格表连接器</h1>
                        <p className="text-slate-400 text-sm mb-6">请输入您的 Vika API Token</p>
                        <input 
                            type="text" 
                            className="w-full border p-3 rounded-lg mb-4 outline-none focus:border-blue-500"
                            placeholder="usk..."
                            value={token}
                            onChange={e => setToken(e.target.value)}
                        />
                        <button onClick={handleEnter} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow-lg shadow-purple-200">
                            进入系统
                        </button>
                        <p className="mt-4 text-xs text-slate-300">数据将存储在您的维格表中</p>
                    </div>
                </div>
            );
        };

        // --- 主界面 ---
        const AppScreen = () => {
            const [papers, setPapers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showModal, setShowModal] = useState(false);
            const [filter, setFilter] = useState('all');

            const loadData = async () => {
                setLoading(true);
                try {
                    const data = await vika.getAll();
                    // 按创建顺序倒序（维格表默认顺序可能不固定，这里前端排一下序也可以，或者依赖维格表视图）
                    setPapers(data.reverse()); 
                } catch (e) {
                    alert("加载失败，请检查配置: " + e.message);
                }
                setLoading(false);
            };

            useEffect(() => {
                loadData();
            }, []);

            const handleAdd = async (form) => {
                // 乐观更新 UI (先显示，后台慢慢存，提高体验)
                const tempId = Date.now().toString();
                const tempPaper = { ...form, status: 'reading', id: tempId, _temp: true };
                setPapers([tempPaper, ...papers]);
                setShowModal(false);

                try {
                    await vika.add(form);
                    loadData(); // 重新拉取以获取真实ID
                } catch (e) {
                    alert("保存失败");
                    setPapers(papers.filter(p => p.id !== tempId));
                }
            };

            const handleToggle = async (paper) => {
                const newStatus = paper.status === 'reading' ? 'done' : 'reading';
                // 乐观更新
                setPapers(papers.map(p => p.id === paper.id ? { ...p, status: newStatus } : p));
                
                await vika.updateStatus(paper.id, newStatus);
            };

            const handleDelete = async (id) => {
                if(!confirm("确认删除？")) return;
                setPapers(papers.filter(p => p.id !== id));
                await vika.delete(id);
            };

            const filtered = papers.filter(p => filter === 'all' || p.status === filter);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 relative pb-24 shadow-xl">
                    <header className="bg-white px-6 pt-12 pb-4 sticky top-0 z-10 border-b border-slate-100 flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-bold text-slate-800">维格表 · 文献库</h1>
                            <a href={`https://vika.cn/workbench/${DATASHEET_ID}`} target="_blank" className="text-xs text-purple-600 hover:underline">
                                打开后台表格 &rarr;
                            </a>
                        </div>
                        <div className="text-xs text-slate-400">永久免费版</div>
                    </header>

                    <div className="flex gap-3 px-6 py-4 overflow-x-auto no-scrollbar">
                        {['all', 'reading', 'done'].map(f => (
                            <button key={f} onClick={() => setFilter(f)} 
                                className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all ${filter === f ? 'bg-purple-600 text-white' : 'bg-white text-slate-500 border border-slate-200'}`}>
                                {f === 'all' ? '全部' : f === 'reading' ? '待读' : '已读'}
                            </button>
                        ))}
                    </div>

                    <div className="px-6 space-y-4">
                        {loading ? <div className="flex justify-center py-10"><div className="loader"></div></div> : 
                        filtered.length === 0 ? <div className="text-center py-20 text-slate-400">暂无数据</div> :
                        filtered.map(paper => (
                            <div key={paper.id} className={`bg-white p-4 rounded-xl shadow-sm border border-slate-100 transition-opacity ${paper._temp ? 'opacity-50' : 'opacity-100'}`}>
                                <div className="flex justify-between items-start">
                                    <div className="flex-1">
                                        <h3 className="font-bold text-slate-800 mb-1">{paper.title}</h3>
                                        <p className="text-sm text-slate-500">{paper.author} · {paper.year}</p>
                                    </div>
                                    <button onClick={() => handleToggle(paper)} className={`ml-3 p-2 rounded-full ${paper.status === 'done' ? 'text-green-500 bg-green-50' : 'text-slate-300 bg-slate-50'}`}>✓</button>
                                </div>
                                <div className="mt-3 flex justify-between border-t border-slate-50 pt-3">
                                    <span className="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">{paper.tag || '未分类'}</span>
                                    <button onClick={() => handleDelete(paper.id)} className="text-xs text-red-300 hover:text-red-500">删除</button>
                                </div>
                            </div>
                        ))}
                    </div>

                    <button onClick={() => setShowModal(true)} className="fixed bottom-8 right-6 w-14 h-14 bg-purple-600 rounded-full text-white text-3xl shadow-lg flex items-center justify-center hover:scale-110 transition-transform active:scale-95 z-20">+</button>

                    {showModal && <Modal onClose={() => setShowModal(false)} onSubmit={handleAdd} />}
                </div>
            );
        };

        const Modal = ({ onClose, onSubmit }) => {
            const [form, setForm] = useState({ title: '', author: '', year: 2024, tag: 'AI' });
            return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
                    <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between mb-6">
                            <h3 className="text-xl font-bold">添加文献</h3>
                            <button onClick={onClose} className="text-slate-400">✕</button>
                        </div>
                        <div className="space-y-4">
                            <input className="w-full border-b py-2 outline-none focus:border-purple-500" placeholder="标题" value={form.title} onChange={e => setForm({...form, title: e.target.value})} />
                            <input className="w-full border-b py-2 outline-none focus:border-purple-500" placeholder="作者" value={form.author} onChange={e => setForm({...form, author: e.target.value})} />
                            <div className="flex gap-4">
                                <input type="number" className="w-full border-b py-2 outline-none" value={form.year} onChange={e => setForm({...form, year: e.target.value})} />
                                <select className="w-full border-b py-2 outline-none bg-transparent" value={form.tag} onChange={e => setForm({...form, tag: e.target.value})}>
                                    <option>AI</option><option>医学</option><option>社科</option><option>其他</option>
                                </select>
                            </div>
                            <button onClick={() => onSubmit(form)} className="w-full bg-purple-600 text-white font-bold py-3 rounded-xl mt-4">保存</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- 根组件：判断是否有Token ---
        const Root = () => {
            // 这里为了简化，我们直接把 Token 写死在代码顶部。
            // 实际运行时，如果你的 Token 填对了，直接展示 App。
            return <AppScreen />; 
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Root />);
    </script>
</body>
</html>